<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pol√≠gono Splitter</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #141414;
            color: #FFFFFF;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; user-select: none; position: relative;
        }

        #main-content {
            z-index: 1; display: flex; flex-direction: column; align-items: center; width: 100%;
            transition: filter 0.3s;
        }

        #logo { width: 150px; margin-bottom: 20px; pointer-events: none; }
        h1 { font-weight: 700; letter-spacing: 2px; margin: 0 0 5px 0; text-transform: uppercase; }
        p { color: #9E9E9E; font-size: 14px; margin-bottom: 40px; }

        button {
            padding: 15px 40px; font-size: 16px; cursor: pointer; border-radius: 4px;
            font-weight: bold; transition: all 0.3s ease; border: none;
        }

        #btn-select { background-color: #D9052E; color: white; box-shadow: 0 4px 15px rgba(217, 5, 46, 0.4); }
        #btn-select:hover { transform: translateY(-2px); background-color: #ff1c45; }
        #btn-select:disabled { background: #333; color: #555; box-shadow: none; cursor: not-allowed; transform: none; }

        #btn-open {
            margin-top: 20px; background: transparent; border: 2px solid #9E9E9E; color: #9E9E9E;
        }
        #btn-open:hover { background: #9E9E9E; color: #141414; }

        /* BARRA DE PROGRESO */
        #progress-container {
            width: 300px; height: 6px; background-color: #333;
            border-radius: 3px; margin-top: 30px; overflow: hidden; display: none;
        }

        #progress-bar {
            width: 0%; height: 100%; background-color: #D9052E;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px #D9052E;
        }

        /* ANIMACI√ìN DE CARGA INDETERMINADA (El efecto "Loading") */
        @keyframes loading-scan {
            0% { left: -50%; width: 30%; }
            50% { left: 25%; width: 50%; }
            100% { left: 100%; width: 30%; }
        }

        #progress-bar.indeterminate {
            position: relative;
            width: 100% !important; /* Llenamos el contenedor */
            background-color: #333; /* Fondo oscuro */
        }
        
        #progress-bar.indeterminate::after {
            content: ''; position: absolute; top: 0; left: 0; bottom: 0;
            background-color: #D9052E;
            animation: loading-scan 1.5s infinite linear;
        }

        #status {
            margin-top: 15px; font-size: 12px; color: #9E9E9E;
            font-family: 'Consolas', monospace; min-height: 20px;
        }

        #drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(20, 20, 20, 0.95);
            border: 8px dashed #D9052E; box-sizing: border-box;
            z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #drop-message { font-size: 40px; font-weight: bold; color: #D9052E; text-transform: uppercase; pointer-events: none; }
    </style>
</head>
<body>
    <div id="main-content">
        <img id="logo" src="logo.png" alt="Pol√≠gono Studio" draggable="false">
        
        <h1>Pol√≠gono Splitter</h1>
        
        <p>Herramienta IA de Separaci√≥n de Stems</p>
        
        <button id="btn-select">SELECCIONAR O ARRASTRAR CANCI√ìN</button>
        
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="status">Esperando archivo...</div>
        <button id="btn-open" style="display:none;">üìÇ ABRIR RESULTADOS</button>
    </div>
    <div id="drop-overlay"><div id="drop-message">üî• DROP IT LIKE IT'S CALIENTE</div></div>

    <script>
        const { ipcRenderer, webUtils } = require('electron');

        const mainContent = document.getElementById('main-content');
        const dropOverlay = document.getElementById('drop-overlay');
        const btnSelect = document.getElementById('btn-select');
        const btnOpen = document.getElementById('btn-open');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        let rutaResultado = "";

        // --- DRAG & DROP ---
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            window.addEventListener(e, preventDefaults, false);
            dropOverlay.addEventListener(e, preventDefaults, false);
        });

        window.addEventListener('dragenter', (e) => {
            dropOverlay.style.display = 'flex'; mainContent.style.filter = 'blur(5px)';
        });
        dropOverlay.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) { dropOverlay.style.display = 'none'; mainContent.style.filter = 'none'; }
        });
        dropOverlay.addEventListener('drop', (e) => {
            dropOverlay.style.display = 'none'; mainContent.style.filter = 'none';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const filePath = webUtils ? webUtils.getPathForFile(files[0]) : files[0].path;
                ipcRenderer.send('archivo-arrastrado', filePath);
            }
        });

        // --- BOTONES ---
        btnSelect.addEventListener('click', () => ipcRenderer.send('abrir-selector-archivo'));
        btnOpen.addEventListener('click', () => ipcRenderer.send('abrir-carpeta-salida', rutaResultado));

        // --- FEEDBACK VISUAL ---
        ipcRenderer.on('inicio-proceso', () => {
            btnSelect.disabled = true;
            btnSelect.innerText = "CARGANDO MOTOR...";
            btnSelect.style.backgroundColor = "#333";
            btnOpen.style.display = 'none';
            
            progressContainer.style.display = 'block';
            progressBar.className = 'indeterminate';
            status.style.color = "#9E9E9E";
        });

        // --- AQUI ESTA EL CAMBIO IMPORTANTE ---
        ipcRenderer.on('actualizar-progreso', (event, datos) => {
            // Quitamos animaci√≥n de carga indeterminada
            if (progressBar.classList.contains('indeterminate')) {
                progressBar.className = '';
                btnSelect.innerText = "SEPARANDO STEMS...";
            }

            // Ahora 'datos' es un objeto: { global: 12, pase: 1, totalPases: 8 }
            progressBar.style.width = datos.global + "%";
            
            // Actualizamos el texto con detalle profesional
            status.innerText = `Procesando... ${datos.global}% (Pase ${datos.pase}/${datos.totalPases})`; 
        });

        ipcRenderer.on('mensaje-consola', (event, texto) => status.innerText = texto);

        ipcRenderer.on('proceso-terminado', (event, ruta) => {
            status.innerText = "‚úÖ ¬°Listo! Stems guardados correctamente.";
            status.style.color = "#FFFFFF";
            progressBar.style.width = "100%";
            rutaResultado = ruta;
            
            setTimeout(() => {
                btnSelect.disabled = false;
                btnSelect.innerText = "SELECCIONAR OTRA";
                btnSelect.style.backgroundColor = "#D9052E";
                btnOpen.style.display = 'inline-block';
            }, 500);
        });

        ipcRenderer.on('error', (event, err) => {
            status.innerText = "‚ùå Error: " + err;
            status.style.color = "#D9052E";
            btnSelect.disabled = false;
            btnSelect.innerText = "REINTENTAR";
            progressBar.className = '';
            progressBar.style.width = "0%";
        });
    </script>
</body>
</html>